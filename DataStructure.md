# Supabase 資料庫結構與設定

此檔案記錄了本專案在 Supabase 中所需的所有資料庫表、儲存桶和安全策略 (RLS) 的 SQL 設定腳本。

---

## 1. 使用者資料表 (`public.profiles`)

此設定會建立一個觸發器，當有新用戶註冊 (在 `auth.users` 表中新增資料) 時，會自動將其基本資料複製到我們自己建立的 `public.profiles` 表中。同時，它也包含了 `profiles` 表的行級安全 (RLS) 策略。

### SQL 腳本

```sql
-- 刪除舊的 RLS 策略、觸發器和函式 (如果存在)，以便重新建立
-- This makes the script re-runnable without errors.
DROP POLICY IF EXISTS "Public profiles are viewable by everyone." ON public.profiles;
DROP POLICY IF EXISTS "Users can update own profile." ON public.profiles;
DROP POLICY IF EXISTS "Users can view their own profile." ON public.profiles;
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user();

-- 1. 建立或替換一個函式，用於在 public.profiles 中為新用戶建立資料
CREATE OR REPLACE FUNCTION public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.profiles (uid, name, email, "photoUrl")
  values (new.id, new.raw_user_meta_data->>'name', new.email, new.raw_user_meta_data->>'avatar_url');
  return new;
end;
$$;

-- 2. 建立一個觸發器，在 auth.users 表有新資料時自動呼叫上述函式
CREATE OR REPLACE TRIGGER on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- 3. 為 'profiles' 表啟用資料列級安全 (RLS)
alter table public.profiles enable row level security;

-- 4. 設定 RLS 策略：只允許用戶讀取和更新自己的 profile
create policy "Users can view their own profile."
  on public.profiles for select
  using ( auth.uid() = uid );

create policy "Users can update own profile."
  on public.profiles for update
  using ( auth.uid() = uid );
```

---

## 2. 筆記資料表 (`public.notes`) 與音訊儲存桶

此設定會建立用於儲存筆記資訊的 `notes` 表，以及一個用於存放上傳音訊檔案的儲存桶 `audio_files`，並設定好相關的安全策略。

### SQL 腳本

```sql
-- 1. 建立 notes 資料表
CREATE TABLE public.notes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    title TEXT,
    audio_url TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- 2. 為 notes 表啟用 RLS
ALTER TABLE public.notes ENABLE ROW LEVEL SECURITY;

-- 3. 建立 RLS 策略，確保用戶只能存取自己的筆記
CREATE POLICY "Allow users to manage their own notes"
ON public.notes
FOR ALL
USING (auth.uid() = user_id);

-- 4. 為音訊檔案建立一個儲存桶 (Storage Bucket)
-- 注意：此處的 'audio_files' bucket 設為 public，方便前端直接播放。
-- 如果需要保護音訊，可以設為 private 並在後端生成有時效的 URL。
INSERT INTO storage.buckets (id, name, public)
VALUES ('audio_files', 'audio_files', true)
ON CONFLICT (id) DO NOTHING;

-- 5. 設定儲存桶的存取策略 (允許登入用戶上傳和讀取自己的檔案)
CREATE POLICY "Allow authenticated users to upload audio"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'audio_files');

CREATE POLICY "Allow users to read their own audio files"
ON storage.objects
FOR SELECT
TO authenticated
USING (bucket_id = 'audio_files' AND owner = auth.uid());
```
